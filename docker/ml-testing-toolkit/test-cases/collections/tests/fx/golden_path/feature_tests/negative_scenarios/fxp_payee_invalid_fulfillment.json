{
    "options": {},
    "name": "fxp_payee_invalid_fulfillment",
    "test_cases": [
      {
        "id": 1,
        "name": "Check that positions for FXP, Payer and Payee are not changed after FXTransfer fails with invalid fulfillment",
        "fileInfo": {
          "path": "collections/tests/fx/golden_path/feature_tests/negative_scenarios/fxp_non_success_states.json",
          "labels": [
            "fx"
          ]
        },
        "meta": {
          "info": "POST /transfers returns PUT /transfers/{ID} with invalid fulfillment"
        },
        "requests": [
            {
              "id": 1,
              "description": "Get party info Copy",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 2,
                "type": "fspiop",
                "asynchronous": true,
                "additionalApi": true,
                "specFile": "spec_files/api_definitions/fspiop_2.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/fspiop_2.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/fspiop_2.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/fspiop_2.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/fspiop_2.0/trigger_templates"
              },
              "operationPath": "/parties/{Type}/{ID}",
              "path": "/parties/MSISDN/{$inputs.toIdValue}",
              "method": "get",
              "params": {
                "Type": "MSISDN",
                "ID": "{$inputs.toIdValue}"
              },
              "url": "{$inputs.HOST_ACCOUNT_LOOKUP_SERVICE}",
              "headers": {
                "Content-Type": "{$inputs.contentType}",
                "Date": "{$function.generic.curDate}",
                "FSPIOP-Source": "{$inputs.FXP_PAYER_DFSP_ID}",
                "Accept": "{$inputs.accept}"
              },
              "disabled": false,
              "tests": {
                "assertions": [
                  {
                    "id": 1,
                    "description": "Response status to be 202",
                    "exec": [
                      "expect(response.status).to.equal(202)"
                    ]
                  },
                  {
                    "id": 3,
                    "description": "Callback Content Length not 0",
                    "exec": [
                      "expect(callback.headers['Content-Length']).to.not.equal('0')"
                    ]
                  },
                  {
                    "id": 4,
                    "description": "Callback body should contain party",
                    "exec": [
                      "expect(callback.body).to.have.property('party')"
                    ]
                  },
                  {
                    "id": 6,
                    "description": "Callback FSPIOP-Destination same as request FSPIOP-Source",
                    "exec": [
                      "expect(callback.headers['fspiop-destination']).to.equal('{$request.headers['FSPIOP-Source']}')"
                    ]
                  },
                  {
                    "id": 8,
                    "description": "Callback partyIdInfo (partyIdType, partyIdentifier)",
                    "exec": [
                      "expect(callback.body.party.partyIdInfo.partyIdType).to.equal('{$inputs.toIdType}')",
                      "expect(callback.body.party.partyIdInfo.partyIdentifier).to.equal('{$inputs.toIdValue}')"
                    ]
                  }
                ]
              }
            },
            {
              "id": 8,
              "description": "Get Accounts for FXP BEFORE fxTransfer",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 1,
                "type": "central_admin",
                "specFile": "spec_files/api_definitions/central_admin_1.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/central_admin_1.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/central_admin_1.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/central_admin_1.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/central_admin_1.0/trigger_templates"
              },
              "operationPath": "/participants/{name}/accounts",
              "path": "/participants/{$inputs.FXP_TESTFXP1_ID}/accounts",
              "method": "get",
              "params": {
                "name": "{$inputs.FXP_TESTFXP1_ID}"
              },
              "url": "{$inputs.HOST_CENTRAL_LEDGER}",
              "scriptingEngine": "javascript",
              "tests": {
                "assertions": []
              },
              "disabled": false,
              "scripts": {
                "postRequest": {
                  "exec": [
                    "var res = response.body;",
                    "",
                    "res.filter(account => account.currency === environment.FXP_SOURCE_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "res.filter(account => account.currency === environment.FXP_TARGET_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "console.log(`FXP Source Currency Position Balance before FxTransfer=${environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote}`);",
                    "",
                    "console.log(`FXP Target Currency Position Balance before FxTransfer=${environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote}`);"
                  ]
                }
              }
            },
            {
              "id": 2,
              "description": "POST /fxQuotes",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 2,
                "type": "fspiop",
                "asynchronous": true,
                "specFile": "spec_files/api_definitions/fspiop_2.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/fspiop_2.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/fspiop_2.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/fspiop_2.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/fspiop_2.0/trigger_templates"
              },
              "operationPath": "/fxQuotes",
              "path": "/fxQuotes",
              "method": "post",
              "body": {
                "conversionRequestId": "{$function.generic.generateUUID}",
                "conversionTerms": {
                  "conversionId": "{$function.generic.generateUUID}",
                  "initiatingFsp": "{$inputs.FXP_PAYER_DFSP_ID}",
                  "counterPartyFsp": "{$inputs.FXP_TESTFXP1_ID}",
                  "amountType": "SEND",
                  "sourceAmount": {
                    "currency": "{$inputs.FXP_SOURCE_CURRENCY}",
                    "amount": "{$inputs.FXP_SOURCE_AMOUNT}"
                  },
                  "targetAmount": {
                    "currency": "{$inputs.FXP_TARGET_CURRENCY}"
                  },
                  "expiration": "{$inputs.FXP_EXPIRATION}"
                }
              },
              "headers": {
                "Accept": "{$inputs.acceptFxQuotes}",
                "Content-Type": "{$inputs.contentTypeFxQuotes}",
                "Date": "{$function.generic.curDate}",
                "FSPIOP-Source": "{$inputs.FXP_PAYER_DFSP_ID}",
                "FSPIOP-Destination": "{$inputs.FXP_TESTFXP1_ID}"
              },
              "url": "{$inputs.HOST_QUOTING_SERVICE}",
              "disabled": false,
              "tests": {
                "assertions": [
                  {
                    "id": 1,
                    "description": "Response status to be 202",
                    "exec": [
                      "expect(response.status).to.equal(202)"
                    ]
                  },
                  {
                    "id": 2,
                    "description": "Response statusText be Accepted",
                    "exec": [
                      "expect(response.statusText).to.equal('Accepted')"
                    ]
                  },
                  {
                    "id": 3,
                    "description": "Callback Content Length not 0",
                    "exec": [
                      "expect(callback.headers['Content-Length']).to.not.equal('0')"
                    ]
                  },
                  {
                    "id": 4,
                    "description": "Callback FSP Destination equal to request FSP Source",
                    "exec": [
                      "expect(callback.headers['fspiop-destination']).to.equal('{$request.headers['FSPIOP-Source']}')"
                    ]
                  },
                  {
                    "id": 5,
                    "description": "Callback body should contain conversionTerms",
                    "exec": [
                      "expect(callback.body).to.have.property('conversionTerms')"
                    ]
                  },
                  {
                    "id": 6,
                    "description": "Callback transferAmount (amount & currency)to match the request",
                    "exec": [
                      "expect(callback.body.conversionTerms.sourceAmount.currency).to.equal('{$request.body.conversionTerms.sourceAmount.currency}')",
                      "expect(callback.body.conversionTerms.targetAmount.currency).to.equal('{$request.body.conversionTerms.targetAmount.currency}')"
                    ]
                  },
                  {
                    "id": 7,
                    "description": "Callback content-type to be fxQuotes",
                    "exec": [
                      "expect(callback.headers['content-type']).to.have.string('application/vnd.interoperability.fxQuotes+json')"
                    ]
                  },
                  {
                    "id": 16,
                    "description": "Callback body should contain condition",
                    "exec": [
                      "expect(callback.body).to.have.property('condition')"
                    ]
                  },
                  {
                    "id": 17,
                    "description": "Callback body should contain target amount",
                    "exec": [
                      "expect(callback.body.conversionTerms.targetAmount).to.have.property('amount')"
                    ]
                  }
                ]
              }
            },
            {
              "id": 8,
              "description": "Get Accounts for FXP after fxTransfer",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 1,
                "type": "central_admin",
                "specFile": "spec_files/api_definitions/central_admin_1.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/central_admin_1.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/central_admin_1.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/central_admin_1.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/central_admin_1.0/trigger_templates"
              },
              "operationPath": "/participants/{name}/accounts",
              "path": "/participants/{$inputs.FXP_TESTFXP1_ID}/accounts",
              "method": "get",
              "params": {
                "name": "{$inputs.FXP_TESTFXP1_ID}"
              },
              "url": "{$inputs.HOST_CENTRAL_LEDGER}",
              "scriptingEngine": "javascript",
              "disabled": false,
              "scripts": {
                "postRequest": {
                  "exec": [
                    "var res = response.body;",
                    "",
                    "res.filter(account => account.currency === environment.FXP_SOURCE_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpSourceCurrencyPositionBalanceAfterFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "res.filter(account => account.currency === environment.FXP_TARGET_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpTargetCurrencyPositionBalanceAfterFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "console.log(`FXP Source Currency Position Balance after FxTransfer=${environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote}`);",
                    "",
                    "console.log(`FXP Target Currency Position Balance after FxTransfer=${environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote}`);"
                  ]
                }
              },
              "tests": {
                "assertions": [
                  {
                    "id": 1,
                    "description": "FXP position before and after should be the same",
                    "exec": [
                      "expect(environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote).to.equal(environment.fxpSourceCurrencyPositionBalanceAfterFxQuote)",
                      "expect(environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote).to.equal(environment.fxpTargetCurrencyPositionBalanceAfterFxQuote)"
                    ]
                  }
                ]
              }
            }
          ]
      },
      {
        "id": 2,
        "name": "Check that positions for FXP, Payer and Payee are not changed after Transfer fails with invalid fulfillment",
        "fileInfo": {
          "path": "collections/tests/fx/golden_path/feature_tests/negative_scenarios/fxp_non_success_states.json",
          "labels": [
            "fx"
          ]
        },
        "meta": {
          "info": "POST /transfers returns PUT /transfers/{ID} with invalid fulfillment"
        },
        "requests": [
            {
              "id": 1,
              "description": "Get party info Copy",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 2,
                "type": "fspiop",
                "asynchronous": true,
                "additionalApi": true,
                "specFile": "spec_files/api_definitions/fspiop_2.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/fspiop_2.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/fspiop_2.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/fspiop_2.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/fspiop_2.0/trigger_templates"
              },
              "operationPath": "/parties/{Type}/{ID}",
              "path": "/parties/MSISDN/{$inputs.toIdValue}",
              "method": "get",
              "params": {
                "Type": "MSISDN",
                "ID": "{$inputs.toIdValue}"
              },
              "url": "{$inputs.HOST_ACCOUNT_LOOKUP_SERVICE}",
              "headers": {
                "Content-Type": "{$inputs.contentType}",
                "Date": "{$function.generic.curDate}",
                "FSPIOP-Source": "{$inputs.FXP_PAYER_DFSP_ID}",
                "Accept": "{$inputs.accept}"
              },
              "disabled": false,
              "tests": {
                "assertions": [
                  {
                    "id": 1,
                    "description": "Response status to be 202",
                    "exec": [
                      "expect(response.status).to.equal(202)"
                    ]
                  },
                  {
                    "id": 3,
                    "description": "Callback Content Length not 0",
                    "exec": [
                      "expect(callback.headers['Content-Length']).to.not.equal('0')"
                    ]
                  },
                  {
                    "id": 4,
                    "description": "Callback body should contain party",
                    "exec": [
                      "expect(callback.body).to.have.property('party')"
                    ]
                  },
                  {
                    "id": 6,
                    "description": "Callback FSPIOP-Destination same as request FSPIOP-Source",
                    "exec": [
                      "expect(callback.headers['fspiop-destination']).to.equal('{$request.headers['FSPIOP-Source']}')"
                    ]
                  },
                  {
                    "id": 8,
                    "description": "Callback partyIdInfo (partyIdType, partyIdentifier)",
                    "exec": [
                      "expect(callback.body.party.partyIdInfo.partyIdType).to.equal('{$inputs.toIdType}')",
                      "expect(callback.body.party.partyIdInfo.partyIdentifier).to.equal('{$inputs.toIdValue}')"
                    ]
                  }
                ]
              }
            },
            {
              "id": 8,
              "description": "Get Accounts for FXP BEFORE fxTransfer",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 1,
                "type": "central_admin",
                "specFile": "spec_files/api_definitions/central_admin_1.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/central_admin_1.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/central_admin_1.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/central_admin_1.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/central_admin_1.0/trigger_templates"
              },
              "operationPath": "/participants/{name}/accounts",
              "path": "/participants/{$inputs.FXP_TESTFXP1_ID}/accounts",
              "method": "get",
              "params": {
                "name": "{$inputs.FXP_TESTFXP1_ID}"
              },
              "url": "{$inputs.HOST_CENTRAL_LEDGER}",
              "scriptingEngine": "javascript",
              "tests": {
                "assertions": []
              },
              "disabled": false,
              "scripts": {
                "postRequest": {
                  "exec": [
                    "var res = response.body;",
                    "",
                    "res.filter(account => account.currency === environment.FXP_SOURCE_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "res.filter(account => account.currency === environment.FXP_TARGET_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "console.log(`FXP Source Currency Position Balance before FxTransfer=${environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote}`);",
                    "",
                    "console.log(`FXP Target Currency Position Balance before FxTransfer=${environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote}`);"
                  ]
                }
              }
            },
            {
              "id": 2,
              "description": "POST /fxQuotes",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 2,
                "type": "fspiop",
                "asynchronous": true,
                "specFile": "spec_files/api_definitions/fspiop_2.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/fspiop_2.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/fspiop_2.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/fspiop_2.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/fspiop_2.0/trigger_templates"
              },
              "operationPath": "/fxQuotes",
              "path": "/fxQuotes",
              "method": "post",
              "body": {
                "conversionRequestId": "{$function.generic.generateUUID}",
                "conversionTerms": {
                  "conversionId": "{$function.generic.generateUUID}",
                  "initiatingFsp": "{$inputs.FXP_PAYER_DFSP_ID}",
                  "counterPartyFsp": "{$inputs.FXP_TESTFXP1_ID}",
                  "amountType": "SEND",
                  "sourceAmount": {
                    "currency": "{$inputs.FXP_SOURCE_CURRENCY}",
                    "amount": "{$inputs.FXP_SOURCE_AMOUNT}"
                  },
                  "targetAmount": {
                    "currency": "{$inputs.FXP_TARGET_CURRENCY}"
                  },
                  "expiration": "{$inputs.FXP_EXPIRATION}"
                }
              },
              "headers": {
                "Accept": "{$inputs.acceptFxQuotes}",
                "Content-Type": "{$inputs.contentTypeFxQuotes}",
                "Date": "{$function.generic.curDate}",
                "FSPIOP-Source": "{$inputs.FXP_PAYER_DFSP_ID}",
                "FSPIOP-Destination": "{$inputs.FXP_TESTFXP1_ID}"
              },
              "url": "{$inputs.HOST_QUOTING_SERVICE}",
              "disabled": false,
              "tests": {
                "assertions": [
                  {
                    "id": 1,
                    "description": "Response status to be 202",
                    "exec": [
                      "expect(response.status).to.equal(202)"
                    ]
                  },
                  {
                    "id": 2,
                    "description": "Response statusText be Accepted",
                    "exec": [
                      "expect(response.statusText).to.equal('Accepted')"
                    ]
                  },
                  {
                    "id": 3,
                    "description": "Callback Content Length not 0",
                    "exec": [
                      "expect(callback.headers['Content-Length']).to.not.equal('0')"
                    ]
                  },
                  {
                    "id": 4,
                    "description": "Callback FSP Destination equal to request FSP Source",
                    "exec": [
                      "expect(callback.headers['fspiop-destination']).to.equal('{$request.headers['FSPIOP-Source']}')"
                    ]
                  },
                  {
                    "id": 5,
                    "description": "Callback body should contain conversionTerms",
                    "exec": [
                      "expect(callback.body).to.have.property('conversionTerms')"
                    ]
                  },
                  {
                    "id": 6,
                    "description": "Callback transferAmount (amount & currency)to match the request",
                    "exec": [
                      "expect(callback.body.conversionTerms.sourceAmount.currency).to.equal('{$request.body.conversionTerms.sourceAmount.currency}')",
                      "expect(callback.body.conversionTerms.targetAmount.currency).to.equal('{$request.body.conversionTerms.targetAmount.currency}')"
                    ]
                  },
                  {
                    "id": 7,
                    "description": "Callback content-type to be fxQuotes",
                    "exec": [
                      "expect(callback.headers['content-type']).to.have.string('application/vnd.interoperability.fxQuotes+json')"
                    ]
                  },
                  {
                    "id": 16,
                    "description": "Callback body should contain condition",
                    "exec": [
                      "expect(callback.body).to.have.property('condition')"
                    ]
                  },
                  {
                    "id": 17,
                    "description": "Callback body should contain target amount",
                    "exec": [
                      "expect(callback.body.conversionTerms.targetAmount).to.have.property('amount')"
                    ]
                  }
                ]
              }
            },
            {
              "id": 8,
              "description": "Get Accounts for FXP after fxTransfer",
              "apiVersion": {
                "minorVersion": 0,
                "majorVersion": 1,
                "type": "central_admin",
                "specFile": "spec_files/api_definitions/central_admin_1.0/api_spec.yaml",
                "callbackMapFile": "spec_files/api_definitions/central_admin_1.0/callback_map.json",
                "responseMapFile": "spec_files/api_definitions/central_admin_1.0/response_map.json",
                "jsfRefFile": "spec_files/api_definitions/central_admin_1.0/mockRef.json",
                "triggerTemplatesFolder": "spec_files/api_definitions/central_admin_1.0/trigger_templates"
              },
              "operationPath": "/participants/{name}/accounts",
              "path": "/participants/{$inputs.FXP_TESTFXP1_ID}/accounts",
              "method": "get",
              "params": {
                "name": "{$inputs.FXP_TESTFXP1_ID}"
              },
              "url": "{$inputs.HOST_CENTRAL_LEDGER}",
              "scriptingEngine": "javascript",
              "disabled": false,
              "scripts": {
                "postRequest": {
                  "exec": [
                    "var res = response.body;",
                    "",
                    "res.filter(account => account.currency === environment.FXP_SOURCE_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpSourceCurrencyPositionBalanceAfterFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "res.filter(account => account.currency === environment.FXP_TARGET_CURRENCY).forEach(curAccount => {",
                    "  if(curAccount.ledgerAccountType === \"POSITION\") {",
                    "    environment.fxpTargetCurrencyPositionBalanceAfterFxQuote= curAccount.value",
                    "  }",
                    "})",
                    "",
                    "console.log(`FXP Source Currency Position Balance after FxTransfer=${environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote}`);",
                    "",
                    "console.log(`FXP Target Currency Position Balance after FxTransfer=${environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote}`);"
                  ]
                }
              },
              "tests": {
                "assertions": [
                  {
                    "id": 1,
                    "description": "FXP position before and after should be the same",
                    "exec": [
                      "expect(environment.fxpSourceCurrencyPositionBalanceBeforeFxQuote).to.equal(environment.fxpSourceCurrencyPositionBalanceAfterFxQuote)",
                      "expect(environment.fxpTargetCurrencyPositionBalanceBeforeFxQuote).to.equal(environment.fxpTargetCurrencyPositionBalanceAfterFxQuote)"
                    ]
                  }
                ]
              }
            }
          ]
      }
      
    ]
  }
  